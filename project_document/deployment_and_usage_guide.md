# 值班表管理MCP - 部署与使用指南
**版本**: 3.2 (最终交付版)
**更新日期**: 2024-05-21

---

## 1. 概述

本指南旨在帮助您成功部署和使用“值班表管理MCP”服务。该服务是一个基于Python FastAPI的Web应用，提供了通过API管理值班表的核心功能。

### **核心特性**
*   **数据库自动管理**: 无需手动创建数据库或表，服务启动时会自动完成初始化。
*   **统一智能导入**: 支持通过Web界面上传Excel文件或提供本地文件路径来导入值班表。
*   **灵活的Excel格式适应**: 不依赖固定的Excel列名，仅需保证列的顺序正确即可。
*   **智能查询与提醒**: 查询值班信息时，会根据数据库状态（是否为空、是否为最后一天）给出智能提示。
*   **精准换班与审计**: 支持对任意两个日期的任意角色进行精确换班，并自动记录每一次操作以供审计。
*   **交互式API文档**: 自带Swagger UI，让您可以直接在浏览器中方便地测试所有API接口。

---

## 2. 部署流程

请遵循以下步骤在您的本地环境中部署此服务。

### 2.1. 环境准备
*   **Python**: 请确保您的环境中已安装 Python 3.8 或更高版本。
*   **MySQL**: 您需要一个正在运行的MySQL 5.7+ 或 MariaDB 10.2+ 数据库服务。

### 2.2. 安装与配置
1.  **获取项目文件**:
    将本项目所有文件（`src`目录, `requirements.txt`等）放置在您的服务器或本地计算机的任意目录下。

2.  **创建并激活虚拟环境 (强烈推荐)**:
    为了避免与系统中其他Python包产生冲突，建议使用虚拟环境。
    ```bash
    # 打开终端，进入项目根目录
    
    # 创建虚拟环境 (venv是虚拟环境的名称，您可以自定义)
    python -m venv venv
    
    # 激活虚拟环境
    # On Windows:
    .\venv\Scripts\activate
    
    # On macOS/Linux:
    source venv/bin/activate
    ```
    激活成功后，您会看到终端提示符前面出现 `(venv)` 字样。

3.  **安装Python依赖**:
    项目的所有依赖库都记录在`requirements.txt`中。
    ```bash
    # 确保您已激活虚拟环境
    pip install -r requirements.txt
    ```

4.  **配置环境变量**:
    项目通过一个名为`.env`的文件来管理数据库连接等配置信息。
    *   在项目根目录下，找到`.env.example`文件，将其复制并重命名为`.env`。
    *   用文本编辑器打开`.env`文件，修改其中的配置项以匹配您的MySQL数据库信息。

    **.env 文件内容示例:**
    ```dotenv
    # .env
    
    # 您的MySQL数据库主机地址 (通常是localhost)
    DB_HOST=127.0.0.1
    
    # 您的MySQL数据库端口 (默认是3306)
    DB_PORT=3306
    
    # 您希望服务使用的数据库名称 (如果不存在，服务会自动创建)
    DB_DATABASE=mcp_duty_schedule
    
    # 您的MySQL用户名 (例如 root)
    DB_USERNAME=root
    
    # 您的MySQL密码
    DB_PASSWORD=your_mysql_password
    ```
    *   **重要提示**: 如果您在Windows环境下手动创建此文件，请确保它以`UTF-8`编码保存，以避免潜在的读取错误。代码已内置逻辑来处理GBK编码作为备选方案，但UTF-8是最佳实践。

### 2.3. 启动服务
一切准备就绪后，在项目根目录的终端中运行以下命令：
```bash
# 确保您已激活虚拟环境
python -m src.main
```
如果一切顺利，您会看到类似以下的输出，代表服务已成功启动：
```
INFO:     Started server process [xxxxx]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

---

## 3. 使用教程 (通过Web API)

服务启动后，您可以通过其自带的交互式API文档来使用所有功能。

请在您的浏览器中打开以下地址：
**[http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)**

您将看到一个类似下图的界面（Swagger UI），其中列出了所有可用的API端点。

### 3.1. `GET /` (欢迎页)
*   **功能**: 检查服务是否正在运行。
*   **使用方法**: 点击该端点，点击 "Try it out"，然后点击 "Execute"。
*   **成功响应**: 会返回一个JSON，包含欢迎信息和文档地址。

### 3.2. `POST /import_schedule/upload` (通过文件上传导入)
*   **功能**: 通过上传一个Excel文件来导入值班表，此操作会清空所有旧数据。
*   **使用方法**:
    1.  点击该端点，点击 "Try it out"。
    2.  在`file`参数处，点击“选择文件”按钮，从您的电脑中选择一个Excel值班表文件。
    3.  点击 "Execute"。
*   **成功响应**: 返回 `{"message": "排班表导入成功！影响行数: X"}`。

### 3.3. `POST /import_schedule/path` (通过服务器路径导入)
*   **功能**: 通过提供服务器上的文件绝对路径来导入值班表，此操作会清空所有旧数据。
*   **使用方法**:
    1.  点击该端点，点击 "Try it out"。
    2.  在`Request body`中，填入一个指向服务器本地Excel文件的JSON。
    3.  **JSON示例**:
        ```json
        {
          "file_path": "D:\\schedules\\duty_2024.xlsx"
        }
        ```
    4.  点击 "Execute"。
*   **成功响应**: 返回 `{"message": "排班表导入成功！影响行数: X"}`。

### 3.4. `GET /get_duty_employee/` (查询值班安排)
*   **功能**: 查询某一天或今天的值班人员。
*   **使用方法**:
    *   点击该端点，点击 "Try it out"。
    *   在`duty_date`参数处，输入您想查询的日期（格式为`YYYY-MM-DD`），或者直接输入字符串`today`来查询当天。
    *   点击 "Execute"。
*   **成功响应**: 返回一个JSON对象，其中包含查询日期和四个专业的值班人员姓名。如果存在智能提醒，`warnings`字段也会有相应内容。

### 3.5. `POST /swap_duty_schedule/` (通过员工姓名换班)
*   **功能**: 对调两个指定日期的特定员工的值班安排，并自动记录审计日志。
*   **使用方法**:
    *   点击该端点，点击 "Try it out"。
    *   在`Request body`中，填入一个JSON对象，指明要对调的两位员工及其所在日期。
    *   **JSON示例**:
        ```json
        {
          "swap_info_1": {
            "duty_date": "2024-05-20",
            "employee_name": "张三"
          },
          "swap_info_2": {
            "duty_date": "2024-05-21",
            "employee_name": "李四"
          }
        }
        ```
        上述示例表示，将5月20日的“张三”与5月21日的“李四”进行换班。服务会自动查找他们当天所在的岗位并进行对调。
    *   点击 "Execute"。
*   **成功响应**: 返回一个JSON，其中`message`字段会描述换班的结果，例如 `成功将 2024-05-20 的 '张三' (全专业值班) 与 2024-05-21 的 '李四' (CS专业投诉值班) 进行了对调。`

### 3.6. `GET /get_swap_logs/` (查询换班日志)
*   **功能**: 查询当前数据版本下发生过的所有换班记录。
*   **使用方法**:
    *   点击该端点，点击 "Try it out"，然后点击 "Execute"。
*   **成功响应**: 返回一个JSON，其中`logs`字段是一个数组，每个元素都是一条格式化好的、人类可读的日志句子。
    *   **响应示例**:
        ```json
        {
          "status": "success",
          "message": "成功查询到 1 条换班日志。",
          "warnings": [],
          "log_count": 1,
          "logs": [
            "[2024-05-21 15:30:00] 换班申请: 2024年05月20日的 '张三' (原全专业值班) 与 2024年05月21日的 '李四' (原CS专业投诉值班) 进行了对调。"
          ]
        }
        ```
